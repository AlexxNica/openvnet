#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

$LOAD_PATH.unshift File.expand_path('../../lib', __FILE__)

require 'rubygems'
require 'bundler/setup'
require 'vnet'
require 'celluloid'
require 'celluloid/autostart'
require 'dcell'

conf = Vnet::Configurations::Vna.conf

#Celluloid.logger = ::Logger.new(File.join(Vnet::LOG_DIR, "#{conf.node.id}.log"))
Celluloid.logger = ::Logger.new(File.join(Vnet::LOG_DIR, "vna.log"))

# Start the switch manager before any celluloid services in order to
# avoid cloned file descriptors to e.g. zmq remaining open.
switch_manager_new = Vnet::NodeModules::SwitchManager.new
switch_manager_new.configure_trema
switch_manager_new.cleanup_current_session
switch_manager_new.kill_old_switches
switch_manager_new.start

Vnet::ModelWrappers::Base.set_proxy(conf.node_api_proxy)

case conf.node_api_proxy
when :rpc
  # do nothing
when :direct
  Vnet::Initializers::DB.run(conf.db_uri)
end

DCell.start(:id => conf.node.id, :addr => conf.node.addr_string,
  :registry => {
    :adapter => conf.registry.adapter,
    :host => conf.registry.host,
    :port => conf.registry.port
})

name = "#{conf.node.id}-#{conf.node.addr.host}"
service_openflow = Vnet::NodeModules::ServiceOpenflow.supervise_as name.to_sym

sleep 5
# DCell::Node[conf.node.id][name.to_sym].foo(event: :leased_ipv4_address,
#                      target_id: 1,
#                      mac_lease_id: 1,
#                      ip_address_id: 1)

Vnet::ModelWrappers::IpLease.batch[1].update({:interface_id => nil}).commit

DCell::Node[conf.node.id][name.to_sym].released_ip(event: :released_ipv4_address,
                     target_id: 1,
                     mac_lease_id: 1,
                     ip_lease_id: 1)

sleep
